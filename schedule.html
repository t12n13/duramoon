<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>スケジュール | Dura Moon</title>
  <link rel="stylesheet" href="assets/common.css">
  <link rel="icon" type="image/png" href="/duramoon/favicon.png" />

  <style>
    /* --- ライブ感のあるカードデザイン --- */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .section-title { display:flex; align-items:center; gap:10px; margin: 12px 0 18px; }
    .section-title .icon { font-size:22px; }
    .events { display: grid; grid-template-columns: 1fr; gap: 14px; }

    .event-card {
      position: relative;
      border-radius: 16px;
      padding: 18px 16px 14px;
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.1);
      overflow: hidden;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .event-card::before {
      content:"";
      position:absolute; inset:-1px;
      border-radius:18px;
      padding:1px;
      background: linear-gradient(135deg, rgba(255,61,138,.8), rgba(115,135,255,.85) 40%, rgba(40,190,255,.9));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      opacity:.45;
      pointer-events:none;
    }
    .event-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
    }

    .event-title { font-weight:700; font-size:1.15rem; margin:0 0 4px; }
    .event-meta { color:#b8c0cc; font-size:.95rem; display:flex; flex-wrap:wrap; gap:8px; }
    .pill { background: rgba(255,255,255,.09); border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:100px; }
    .dot { width:6px; height:6px; border-radius:50%; background:rgba(255,255,255,.35); display:inline-block; }
    .btns { display:flex; flex-wrap:wrap; gap:10px; margin-top:14px; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px;
           border:1px solid rgba(255,255,255,.12); color:#f5f7ff; font-weight:700;
           background: rgba(28,30,40,.7); text-decoration:none; }
    .btn.ticket { background: linear-gradient(135deg, #ff4da6, #7b5cff); }
    .btn.site { background: linear-gradient(135deg, #23c6ff, #358bff); }
    .btn:hover { filter: brightness(1.08); transform: translateY(-1px); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="section-title"><span class="icon">📅</span> スケジュール</h1>
      <p>Googleカレンダーから予定を取得して表示します。カレンダー側を更新すると自動で反映されます。</p>
      <nav><a class="btn" href="./">SNSまとめ</a></nav>
    </header>

    <section id="list">
      <div id="events" class="events"></div>
    </section>
  </div>

  <script src="assets/config.js"></script>
  <script>
    // ==== 日付フォーマット ====
    const fmtJP = iso => new Intl.DateTimeFormat('ja-JP', {
      year:'numeric', month:'long', day:'numeric',
      weekday:'short', hour:'2-digit', minute:'2-digit', hour12:false
    }).format(new Date(iso));

    const fmtHM = iso => new Intl.DateTimeFormat('ja-JP', {
      hour:'2-digit', minute:'2-digit', hour12:false
    }).format(new Date(iso));

    const daysLeft = iso => {
      const now = new Date(), t = new Date(iso);
      const ms = t.setHours(0,0,0,0) - now.setHours(0,0,0,0);
      return Math.floor(ms / (1000*60*60*24));
    };

    // ==== descriptionを解析 ====
    function parseFields(desc = '') {
      const fields = {};
      if (!desc) return fields;

      const text = String(desc).replace(/\r/g, '');
      const re = /(?:^|\n)\s*(ticket|url|price|venue)\s*:\s*(.*?)(?=\n\s*(?:ticket|url|price|venue)\s*:|$)/gis;
      let m;
      while ((m = re.exec(text))) {
        const key = m[1].toLowerCase();
        let val = (m[2] || '').trim();
        // ticket / url は URL のみ抽出
        if (key === 'ticket' || key === 'url') {
          const hit = val.match(/[^\s]+/);
          if (hit) val = hit[0];
        }
        fields[key] = val;
      }
      return fields;
    }

    function googleEventUrl(e) {
      return e.htmlLink || `https://calendar.google.com/calendar/u/0/r/eventedit?text=${encodeURIComponent(e.summary||'')}`;
    }

    async function loadEvents() {
      const el = document.getElementById('events');
      el.innerHTML = '読み込み中...';

      const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CONFIG.CAL_ID)}/events`);
      url.searchParams.set('key', CONFIG.API_KEY);
      url.searchParams.set('singleEvents', 'true');
      url.searchParams.set('orderBy', 'startTime');
      url.searchParams.set('timeMin', new Date().toISOString());
      url.searchParams.set('maxResults', '50');

      const res = await fetch(url);
      if (!res.ok) {
        el.innerHTML = `<div class="empty">読み込み失敗。APIキー設定を確認してください。</div>`;
        return;
      }

      const data = await res.json();
      const items = (data.items || []).filter(e => e.status !== 'cancelled');
      if (!items.length) {
        el.innerHTML = `<div class="empty">今後の予定はありません。</div>`;
        return;
      }

      el.innerHTML = '';
      for (const e of items) {
        const start = e.start?.dateTime || e.start?.date + 'T00:00:00';
        const end = e.end?.dateTime || e.end?.date + 'T23:59:59';
        const fields = parseFields(e.description || '');
        const venue = fields.venue || '';
        const price = fields.price || '';
        const ticket = fields.ticket || '';
        const site = fields.url || '';
        const countdown = daysLeft(start) >= 0 ? `<span class="pill">⏳ あと${daysLeft(start)}日</span>` : '';

        const card = document.createElement('article');
        card.className = 'event-card';
        card.innerHTML = `
          <h3 class="event-title">${e.summary || '(無題)'}</h3>
          <div class="event-meta">
            <span class="pill">📅 ${fmtJP(start)}</span>
            <span class="pill">🕒 ${fmtHM(start)}〜${fmtHM(end)}</span>
            ${venue ? `<span class="pill">📍 ${venue}</span>` : ''}
            ${price ? `<span class="pill">💴 ${price}</span>` : ''}
            ${countdown}
          </div>
          <div class="btns">
            ${ticket ? `<a class="btn ticket" href="${ticket}" target="_blank">🎫 チケット</a>` : ''}
            ${site ? `<a class="btn site" href="${site}" target="_blank">🔗 公式サイト</a>` : ''}
            <a class="btn" href="${googleEventUrl(e)}" target="_blank">📆 Googleカレンダーで開く</a>
          </div>`;
        el.appendChild(card);
      }
    }

    loadEvents();
  </script>
</body>
</html>
