<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>スケジュール | Dura Moon</title>
  <link rel="stylesheet" href="assets/common.css" />
  <link rel="icon" type="image/png" href="/duramoon/favicon.png" />

  <style>
    /* ===== ライブ感のあるカードデザイン ===== */
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .section-title{display:flex;align-items:center;gap:10px;margin:12px 0 18px}
    .section-title .icon{font-size:22px}
    .note{opacity:.85}
    .events{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:760px){.events{grid-template-columns:1fr}}

    .event-card{
      position:relative;border-radius:16px;padding:18px 16px 14px;
      background:rgba(255,255,255,.06);backdrop-filter:blur(6px);
      border:1px solid rgba(255,255,255,.1);overflow:hidden;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .event-card::before{
      content:"";position:absolute;inset:-1px;border-radius:18px;padding:1px;
      background:linear-gradient(135deg, rgba(255,61,138,.8), rgba(115,135,255,.85) 40%, rgba(40,190,255,.9));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;opacity:.45;pointer-events:none;
    }
    .event-card:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(0,0,0,.25)}

    .event-head{display:flex;align-items:flex-start;gap:12px}
    .event-title{font-weight:700;font-size:1.15rem;line-height:1.35;margin:0 0 4px;letter-spacing:.2px}
    .event-meta{color:var(--muted,#b8c0cc);font-size:.95rem;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:100px}
    .dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.35);display:inline-block}

    .event-body{margin-top:10px;color:#e6ebff;font-size:.98rem}
    .event-desc{color:#d7def4;opacity:.9}

    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);color:#f5f7ff;text-decoration:none;font-weight:700;letter-spacing:.2px;
      background:rgba(28,30,40,.7);transition:filter .15s ease, transform .15s ease}
    .btn:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .btn.ticket{background:linear-gradient(135deg,#ff4da6,#7b5cff)}
    .btn.site{background:linear-gradient(135deg,#23c6ff,#358bff)}
    .btn.gcal{background:rgba(28,32,45,.7)}

    .countdown{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:.88rem;
      font-weight:700;background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.15)}

    .empty{color:#dbe2f3;opacity:.85;padding:18px 16px;border-radius:14px;border:1px dashed rgba(255,255,255,.15);
      background:rgba(255,255,255,.04)}

    /* リンク化した “チップ” 表示 */
    .chip-link,.chip-tag,.chip-at{
      display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.13);
      color:#eef3ff;text-decoration:none;margin:2px 4px 0 0;white-space:nowrap
    }
    .chip-ic{width:16px;height:16px;border-radius:3px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="section-title"><span class="icon">📅</span> スケジュール</h1>
      <p class="note">Googleカレンダーから予定を取得して表示します。カレンダー側を更新すると自動で反映されます。</p>
      <nav class="nav"><a class="btn gcal" href="./" style="margin-top:10px;">SNSまとめ</a></nav>
    </header>

    <section style="margin-top:12px">
      <div id="events" class="events"></div>
    </section>
  </div>

  <!-- APIキーとカレンダーID（assets/config.js） -->
  <script src="assets/config.js"></script>
  <script>
    /* ========= ユーティリティ ========= */
    const fmtJP = iso => {
      const d = new Date(iso);
      return new Intl.DateTimeFormat('ja-JP', {
        year:'numeric', month:'long', day:'numeric',
        weekday:'short', hour:'2-digit', minute:'2-digit', hour12:false
      }).format(d);
    };
    const fmtHM = iso => {
      const d = new Date(iso);
      return new Intl.DateTimeFormat('ja-JP', {hour:'2-digit',minute:'2-digit',hour12:false}).format(d);
    };
    const daysLeft = iso => {
      const now = new Date(), t = new Date(iso);
      const ms = t.setHours(0,0,0,0) - now.setHours(0,0,0,0);
      return Math.floor(ms/(1000*60*60*24));
    };

    // description から key:value を抽出（ticket, url, price, venue）
    function parseFields(desc=''){
      const fields={}; const lines=(desc||'').split(/\r?\n/);
      for(const line of lines){
        const m=line.match(/^\s*(ticket|url|price|venue)\s*:\s*(.+)\s*$/i);
        if(m) fields[m[1].toLowerCase()]=m[2].trim();
      }
      return fields;
    }

    // イベント編集/表示ページへのリンク
    function googleEventUrl(e){
      return e.htmlLink || `https://calendar.google.com/calendar/u/0/r/eventedit?text=${encodeURIComponent(e.summary||'')}`;
    }

    // URLの表示を短縮してチップ表示に使う
    function shortenUrl(u){
      try{
        const url=new URL(u);
        let path=url.pathname.replace(/\/$/,'');
        if(path.length>24) path=path.slice(0,24)+'…';
        return `${url.host}${path?path:''}`;
      }catch{return u;}
    }
    // favicons
    function faviconFor(u){
      try{
        const host=new URL(u).host;
        return `https://www.google.com/s2/favicons?domain=${host}&sz=16`;
      }catch{return '';}
    }

    // URL/ハッシュタグ/メンションをリンク化
    function linkifyText(text){
      if(!text) return '';
      const esc=s=>s.replace(/[&<>]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]));
      let html=esc(text).replace(/\r?\n/g,'<br>');

      html=html.replace(/https?:\/\/[^\s<>()]+/g,m=>{
        let show=shortenUrl(m), fav=faviconFor(m);
        const host=new URL(m).host;
        const isX=/(^|\.)x\.com$|(^|\.)twitter\.com$/i.test(host);
        const icon=isX?'🕊️':(fav?`<img src="${fav}" alt="" class="chip-ic">`:'🔗');
        return `<a class="chip-link" href="${m}" target="_blank" rel="noopener">${icon}<span>${show}</span></a>`;
      });

      html=html.replace(/(^|[\s>])#([\p{L}\p{N}_]+)\b/gu,(_m,pre,tag)=>{
        const url=`https://x.com/hashtag/${encodeURIComponent(tag)}`;
        return `${pre}<a class="chip-tag" href="${url}" target="_blank" rel="noopener">#${tag}</a>`;
      });
      html=html.replace(/(^|[\s>])@([A-Za-z0-9_]{1,15})\b/g,(_m,pre,id)=>{
        const url=`https://x.com/${id}`;
        return `${pre}<a class="chip-at" href="${url}" target="_blank" rel="noopener">@${id}</a>`;
      });
      return html;
    }

    /* ========= 本体：イベント取得＆描画 ========= */
    async function loadEvents(){
      const eventsEl=document.getElementById('events');
      eventsEl.innerHTML='<div class="empty">読み込み中…</div>';

      const timeMin=new Date(); timeMin.setHours(0,0,0,0);

      const url=new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CONFIG.CAL_ID)}/events`);
      url.searchParams.set('key',CONFIG.API_KEY);
      url.searchParams.set('singleEvents','true');
      url.searchParams.set('orderBy','startTime');
      url.searchParams.set('timeMin',timeMin.toISOString());
      url.searchParams.set('maxResults','50');

      const res=await fetch(url);
      if(!res.ok){
        eventsEl.innerHTML='<div class="empty">読み込みに失敗しました。APIキーの制限（HTTPリファラー）とカレンダーの公開設定をご確認ください。</div>';
        return;
      }
      const data=await res.json();
      const items=(data.items||[]).filter(e=>!e.status||e.status!=='cancelled');

      if(!items.length){
        eventsEl.innerHTML='<div class="empty">今後の予定はありません。</div>';
        return;
      }

      eventsEl.innerHTML='';
      for(const e of items){
        const start=e.start?.dateTime||(e.start?.date?e.start.date+'T00:00:00':null);
        const end  =e.end?.dateTime  ||(e.end?.date  ?e.end.date  +'T23:59:59':null);
        if(!start) continue;

        const fields=parseFields(e.description||'');
        const venue=e.location||fields.venue||'';
        const price=fields.price||'';
        const ticket=fields.ticket||'';
        const site=fields.url||'';

        const d=daysLeft(start);
        const countdown=d>=0?`<span class="countdown">⏳ あと ${d} 日</span>`:'';
        const timeText=end?`${fmtHM(start)} 〜 ${fmtHM(end)}`:fmtHM(start);

        const cleanedDesc=(e.description||'').replace(/\r\n/g,'\n');
        const htmlDesc=linkifyText(cleanedDesc);

        const card=document.createElement('article');
        card.className='event-card';
        card.innerHTML = `
          <div class="event-head">
            <div style="flex:1">
              <h3 class="event-title">${e.summary || '(無題)'}</h3>
              <div class="event-meta">
                <span class="pill">📅 ${fmtJP(start)}</span>
                <span class="dot"></span>
                <span class="pill">🕒 ${timeText}</span>
                ${venue ? `<span class="dot"></span><span class="pill">📍 ${venue}</span>` : ''}
                ${price ? `<span class="dot"></span><span class="pill">💴 ${price}</span>` : ''}
                ${countdown ? `<span class="dot"></span>${countdown}` : ''}
              </div>
            </div>
          </div>

          ${htmlDesc ? `<div class="event-body"><div class="event-desc">${htmlDesc}</div></div>` : ''}

          <div class="btns">
            ${ticket ? `<a class="btn ticket" href="${ticket}" target="_blank" rel="noopener">🎟 チケット</a>` : ''}
            ${site   ? `<a class="btn site"   href="${site}"   target="_blank" rel="noopener">🔗 公式サイト</a>` : ''}
            <a class="btn gcal" href="${googleEventUrl(e)}" target="_blank" rel="noopener">📆 Googleカレンダーで開く</a>
          </div>
        `;
        eventsEl.appendChild(card);
      }
    }

    loadEvents();
  </script>
</body>
</html>
