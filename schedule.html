<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | Dura Moon</title>
  <link rel="stylesheet" href="assets/common.css">
  <link rel="icon" type="image/png" href="/duramoon/favicon.png" />

  <style>
    :root{
      --card-bg: rgba(9,12,30,.78);
      --card-border: rgba(255,255,255,.1);
      --muted:#b9c2da;
      --accent:#ff4fa3;
      --accent-soft:rgba(255,79,163,.16);
      --warn:#facc15;
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    }

    .wrap{
      max-width:1100px;
      margin:0 auto 64px;
      padding:0 16px 32px;
    }

    /* ---------- ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ãƒ’ãƒ¼ãƒ­ãƒ¼ ---------- */
    .page-hero {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      max-width:1100px;
      margin:20px auto 12px;
      padding:0 16px;
    }
    .page-hero-main {
      display:flex;
      align-items:center;
      gap:12px;
    }
    .page-hero-icon {
      font-size:32px;
    }
    .page-hero-title {
      font-size:1.6rem;
      font-weight:800;
      letter-spacing:.06em;
    }
    .page-hero-sub {
      margin-top:4px;
      font-size:.95rem;
      color:var(--muted);
    }
    .page-hero-link{
      margin-top:4px;
      padding:8px 14px;
      border-radius:999px;
      font-size:.9rem;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.35);
      text-decoration:none;
      color:#f5f7ff;
      white-space:nowrap;
    }
    .page-hero-link:hover{
      background:rgba(255,255,255,.06);
    }
    @media (max-width:640px){
      .page-hero{
        flex-direction:column;
        align-items:flex-start;
      }
      .page-hero-title{
        font-size:1.4rem;
      }
      .page-hero-link{
        margin-top:12px;
      }
    }

    /* ---------- æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ---------- */

    .cal-wrapper{
      margin:8px 0 26px;
      padding:14px 16px 18px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(4,8,26,.78);
      backdrop-filter:blur(16px);
    }
    .cal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .cal-title{
      font-weight:700;
      letter-spacing:.1em;
    }
    .cal-nav{
      display:flex;
      gap:8px;
    }
    .cal-nav button{
      border:none;
      background:rgba(255,255,255,.09);
      color:#fff;
      width:30px;
      height:30px;
      border-radius:999px;
      cursor:pointer;
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cal-nav button:hover{
      background:rgba(255,255,255,.16);
    }
    .cal-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      margin-top:6px;
    }
    .cal-dow{
      text-align:center;
      font-size:.8rem;
      color:var(--muted);
      padding:2px 0 4px;
    }
    .cal-day{
      position:relative;
      border:none;
      width:100%;
      aspect-ratio:1 / 1;
      border-radius:12px;
      font-size:.9rem;
      color:#e5edff;
      background:rgba(255,255,255,.03);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cal-day span{
      position:relative;
      z-index:2;
    }
    .cal-day.has-event::after{
      content:"";
      position:absolute;
      bottom:6px;
      left:50%;
      width:6px;
      height:6px;
      border-radius:50%;
      background:#fed14b;
      transform:translateX(-50%);
    }
    .cal-day.is-today{
      outline:2px solid #60a5fa;
      outline-offset:-2px;
    }
    .cal-day.is-selected{
      background:linear-gradient(135deg,#4f46e5,#ec4899);
    }
    .cal-day.is-weekend{
      color:#fbbf24;
    }
    .cal-day.empty{
      background:transparent;
      cursor:default;
    }

    @media (max-width:640px){
      .cal-wrapper{
        padding-inline:10px;
      }
    }

    /* ---------- ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ ---------- */

    .events{
      display:grid;
      grid-template-columns:1fr;
      gap:18px;
    }

    .event-card{
      position:relative;
      border-radius:18px;
      padding:18px 16px 16px;
      background:var(--card-bg);
      border:1px solid var(--card-border);
      backdrop-filter:blur(12px);
      overflow:hidden;
    }
    .event-card::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:20px;
      padding:1px;
      background:linear-gradient(135deg,rgba(255,61,138,.8),rgba(115,135,255,.85) 40%,rgba(40,190,255,.9));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      opacity:.35;
      pointer-events:none;
    }
    .event-head{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:6px;
    }
    .event-title{
      font-size:1.1rem;
      font-weight:700;
      letter-spacing:.03em;
      margin:0;
    }
    .event-meta-line{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:.9rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 9px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      white-space:nowrap;
    }
    .pill.badge{
      background:var(--accent-soft);
      border-color:rgba(255,255,255,.25);
    }
    .pill.night{
      background:rgba(15,23,42,.9);
      border-color:rgba(148,163,184,.7);
    }
    .pill.day{
      background:rgba(22,163,74,.16);
      border-color:rgba(45,212,191,.7);
    }
    .countdown-pill{
      background:rgba(248,250,252,.04);
      border-color:rgba(251,191,36,.7);
      color:#fde68a;
    }

    .event-body{
      margin-top:10px;
      font-size:.95rem;
      color:#e5ebff;
    }
    .event-desc{
      color:#d7def4;
    }

    .event-note{
      margin-top:10px;
      padding:8px 10px;
      border-radius:10px;
      border:1px dashed rgba(252,211,77,.7);
      background:rgba(252,211,77,.08);
      font-size:.92rem;
      color:#fef3c7;
    }

    .event-flyer{
      margin-top:10px;
      border-radius:12px;
      width:100%;
      max-height:260px;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
    }

    .btns{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:14px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(15,23,42,.9);
      color:#f9fafb;
      font-size:.9rem;
      font-weight:600;
      text-decoration:none;
      cursor:pointer;
      min-width:0;
      flex:1 1 130px;
    }
    .btn-ticket{
      background:linear-gradient(135deg,#f97316,#ec4899);
    }
    .btn-x{
      background:linear-gradient(135deg,#0f172a,#1d4ed8);
    }
    .btn-map{
      background:linear-gradient(135deg,#22c55e,#16a34a);
    }
    .btn-gcal{
      background:rgba(15,23,42,.9);
    }
    .btn:hover{
      filter:brightness(1.06);
      transform:translateY(-1px);
    }

    .empty{
      margin-top:16px;
      padding:18px 16px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.2);
      background:rgba(15,23,42,.9);
      color:#e5edff;
      font-size:.95rem;
    }

    /* linkify chips (ä»Šå¾Œä½¿ã†ç”¨) */
    .chip-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(148,163,184,.16);
      color:#e5edff;
      text-decoration:none;
      font-size:.85rem;
    }

  </style>
</head>

<body>
  <div class="page-hero">
    <div class="page-hero-main">
      <div class="page-hero-icon">ğŸ“…</div>
      <div class="page-hero-text">
        <div class="page-hero-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
        <div class="page-hero-sub">ãƒ‰ã‚¥ãƒ©ãƒ»ãƒ ãƒ¼ãƒ³ã®ãƒ©ã‚¤ãƒ– / ã‚¤ãƒ™ãƒ³ãƒˆäºˆå®šä¸€è¦§ã§ã™ã€‚</div>
      </div>
    </div>
    <a class="page-hero-link" href="./">SNSã¾ã¨ã‚ã¸æˆ»ã‚‹</a>
  </div>

  <div class="wrap">
    <!-- æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <section class="cal-wrapper">
      <div class="cal-header">
        <div class="cal-title" id="cal-title">2025å¹´ 12æœˆ</div>
        <div class="cal-nav">
          <button id="cal-prev" aria-label="å‰ã®æœˆ">â€¹</button>
          <button id="cal-next" aria-label="æ¬¡ã®æœˆ">â€º</button>
        </div>
      </div>
      <div class="cal-grid" id="cal-grid">
        <!-- JS ã§ç”Ÿæˆ -->
      </div>
    </section>

    <!-- ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ -->
    <section id="list">
      <div id="events" class="events"></div>
    </section>
  </div>

  <script src="assets/config.js"></script>
  <script>
    // ===== ãƒ˜ãƒ«ãƒ‘ãƒ¼ =====

    const fmtJPDate = (iso) => {
      const d = new Date(iso);
      return new Intl.DateTimeFormat('ja-JP', {
        year:'numeric', month:'long', day:'numeric',
        weekday:'short'
      }).format(d);
    };

    const fmtHM = (iso) => {
      const d = new Date(iso);
      return new Intl.DateTimeFormat('ja-JP',{
        hour:'2-digit', minute:'2-digit', hour12:false
      }).format(d);
    };

    const toYMD = (date) => {
      const d = new Date(date);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };

    const daysLeft = (iso) => {
      const now = new Date();
      const t = new Date(iso);
      const ms = t.setHours(0,0,0,0) - now.setHours(0,0,0,0);
      return Math.floor(ms / (1000*60*60*24));
    };

    // description ã‹ã‚‰ key/value ã¨ æœ¬æ–‡ ã‚’åˆ†é›¢
    function parseFields(desc = '') {
      const fields = {};
      const bodyLines = [];

      const lines = (desc || '').split(/\r?\n/);
      for (const line of lines) {
        const meta = line.match(/^\s*(venue|live|photo|bonus|ticket|price|url|note|map|flyer)\s*:\s*(.+)\s*$/i);
        if (meta) {
          fields[meta[1].toLowerCase()] = meta[2].trim();
        } else if (!/^\s*$/.test(line)) {
          bodyLines.push(line);
        }
      }
      return {
        fields,
        body: bodyLines.join('\n'),
      };
    }

    function bandType(startIso){
      const d = new Date(startIso);
      const h = d.getHours();
      if (h < 17) return { label:'â˜€ï¸ æ˜¼å¸¯', cls:'day' };
      return { label:'ğŸŒ™ å¤œå¸¯', cls:'night' };
    }

    function googleEventUrl(e){
      return e.htmlLink || `https://calendar.google.com/calendar/u/0/r/eventedit?text=${encodeURIComponent(e.summary||'')}`;
    }

    function buildMapUrl(fields, venue){
      if (fields.map) return fields.map;
      if (venue) {
        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(venue)}`;
      }
      return '';
    }

    // ====== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ / ã‚¤ãƒ™ãƒ³ãƒˆæç”»ç”¨ã®çŠ¶æ…‹ ======
    let allEvents = [];
    const eventsByDate = new Map(); // ymd => array
    let currentMonth = new Date();
    let selectedDate = null; // 'YYYY-MM-DD'

    // ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» =====

    const calGridEl = document.getElementById('cal-grid');
    const calTitleEl = document.getElementById('cal-title');

    function renderCalendar(){
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth(); // 0-index

      calTitleEl.textContent = `${year}å¹´ ${month+1}æœˆ`;

      // æ›œæ—¥ãƒ˜ãƒƒãƒ€
      calGridEl.innerHTML = '';
      const dows = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
      for (let i=0;i<7;i++){
        const div = document.createElement('div');
        div.className = 'cal-dow';
        div.textContent = dows[i];
        calGridEl.appendChild(div);
      }

      const first = new Date(year, month, 1);
      const firstDow = first.getDay();
      const lastDate = new Date(year, month+1, 0).getDate();
      const todayYMD = toYMD(new Date());

      // å‰ã®æœˆã®ç©ºã
      for (let i=0;i<firstDow;i++){
        const btn = document.createElement('button');
        btn.className = 'cal-day empty';
        btn.disabled = true;
        calGridEl.appendChild(btn);
      }

      // 1æ—¥ã€œæœ«æ—¥
      for (let date=1; date<=lastDate; date++){
        const cellDate = new Date(year, month, date);
        const ymd = toYMD(cellDate);
        const btn = document.createElement('button');
        btn.className = 'cal-day';
        const span = document.createElement('span');
        span.textContent = date;
        btn.appendChild(span);

        const dow = cellDate.getDay();
        if (dow === 0 || dow === 6) {
          btn.classList.add('is-weekend');
        }
        if (ymd === todayYMD){
          btn.classList.add('is-today');
        }
        if (eventsByDate.has(ymd)){
          btn.classList.add('has-event');
        }
        if (ymd === selectedDate){
          btn.classList.add('is-selected');
        }

        btn.addEventListener('click', () => {
          selectedDate = ymd;
          renderCalendar();
          renderEvents();
        });

        calGridEl.appendChild(btn);
      }
    }

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆæç”» =====

    const eventsEl = document.getElementById('events');

    function renderEvents(){
      if (!allEvents.length){
        eventsEl.innerHTML = `<div class="empty">ä»Šå¾Œã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      let list = [];
      if (selectedDate && eventsByDate.has(selectedDate)){
        list = [...eventsByDate.get(selectedDate)];
      } else {
        // ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€ä»Šå¾Œã®å…¨ã‚¤ãƒ™ãƒ³ãƒˆ
        list = [...allEvents];
      }

      if (!list.length){
        eventsEl.innerHTML = `<div class="empty">ã“ã®æ—¥ã«äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      eventsEl.innerHTML = '';

      list.forEach((ev) => {
        const card = document.createElement('article');
        card.className = 'event-card';

        const h = document.createElement('div');
        h.className = 'event-head';

        const title = document.createElement('h3');
        title.className = 'event-title';
        title.textContent = ev.summary || '(ç„¡é¡Œ)';
        h.appendChild(title);

        const meta1 = document.createElement('div');
        meta1.className = 'event-meta-line';

        const datePill = document.createElement('div');
        datePill.className = 'pill';
        datePill.textContent = `ğŸ“… ${fmtJPDate(ev.startIso)}`;
        meta1.appendChild(datePill);

        const timePill = document.createElement('div');
        timePill.className = 'pill';
        const timeText = ev.endIso ? `${fmtHM(ev.startIso)} ã€œ ${fmtHM(ev.endIso)}` : fmtHM(ev.startIso);
        timePill.textContent = `â° ${timeText}`;
        meta1.appendChild(timePill);

        const band = bandType(ev.startIso);
        const bandPill = document.createElement('div');
        bandPill.className = `pill ${band.cls}`;
        bandPill.textContent = band.label;
        meta1.appendChild(bandPill);

        const dLeft = daysLeft(ev.startIso);
        if (!Number.isNaN(dLeft)) {
          const cPill = document.createElement('div');
          cPill.className = 'pill countdown-pill';
          cPill.textContent = dLeft >= 0 ? `â³ ã‚ã¨ ${dLeft} æ—¥` : `â³ çµ‚äº†`;
          meta1.appendChild(cPill);
        }

        h.appendChild(meta1);

        const meta2 = document.createElement('div');
        meta2.className = 'event-meta-line';

        if (ev.venue){
          const vP = document.createElement('div');
          vP.className = 'pill';
          vP.textContent = `ğŸ“ ${ev.venue}`;
          meta2.appendChild(vP);
        }
        if (ev.price){
          const pP = document.createElement('div');
          pP.className = 'pill';
          pP.textContent = `ğŸ’´ ${ev.price}`;
          meta2.appendChild(pP);
        }

        h.appendChild(meta2);
        card.appendChild(h);

        if (ev.bodyHtml){
          const body = document.createElement('div');
          body.className = 'event-body';
          body.innerHTML = `<div class="event-desc">${ev.bodyHtml}</div>`;
          card.appendChild(body);
        }

        if (ev.note){
          const noteEl = document.createElement('div');
          noteEl.className = 'event-note';
          noteEl.textContent = `ğŸ“ ${ev.note}`;
          card.appendChild(noteEl);
        }

        if (ev.flyer){
          const img = document.createElement('img');
          img.className = 'event-flyer';
          img.src = ev.flyer;
          img.alt = `${ev.summary || ''} ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼`;
          card.appendChild(img);
        }

        const btns = document.createElement('div');
        btns.className = 'btns';

        if (ev.ticket){
          const b = document.createElement('a');
          b.className = 'btn btn-ticket';
          b.href = ev.ticket;
          b.target = '_blank';
          b.rel = 'noopener';
          b.textContent = 'ğŸ« ãƒã‚±ãƒƒãƒˆ';
          btns.appendChild(b);
        }

        if (ev.site){
          const b = document.createElement('a');
          b.className = 'btn btn-x';
          b.href = ev.site;
          b.target = '_blank';
          b.rel = 'noopener';
          b.textContent = 'ğŸ•Š Xå‘ŠçŸ¥ãƒã‚¹ãƒˆã‚’è¦‹ã‚‹';
          btns.appendChild(b);
        }

        if (ev.mapUrl){
          const b = document.createElement('a');
          b.className = 'btn btn-map';
          b.href = ev.mapUrl;
          b.target = '_blank';
          b.rel = 'noopener';
          b.textContent = 'ğŸ“ Googleãƒãƒƒãƒ—';
          btns.appendChild(b);
        }

        const g = document.createElement('a');
        g.className = 'btn btn-gcal';
        g.href = googleEventUrl(ev.raw);
        g.target = '_blank';
        g.rel = 'noopener';
        g.textContent = 'ğŸ“… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§é–‹ã';
        btns.appendChild(g);

        card.appendChild(btns);

        eventsEl.appendChild(card);
      });
    }

    // ===== Google Calendar ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆå–å¾— =====

    async function loadEvents(){
      const timeMin = new Date();
      timeMin.setHours(0,0,0,0);

      const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CONFIG.CAL_ID)}/events`);
      url.searchParams.set('key', CONFIG.API_KEY);
      url.searchParams.set('singleEvents','true');
      url.searchParams.set('orderBy','startTime');
      url.searchParams.set('timeMin', timeMin.toISOString());
      url.searchParams.set('maxResults','100');

      eventsEl.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­â€¦';

      const res = await fetch(url);
      if(!res.ok){
        eventsEl.innerHTML = `<div class="empty">
          èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã®åˆ¶é™ï¼ˆHTTPãƒªãƒ•ã‚¡ãƒ©ãƒ¼ï¼‰ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å…¬é–‹è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚
        </div>`;
        return;
      }

      const data = await res.json();
      const items = (data.items || []).filter(e => !e.status || e.status !== 'cancelled');

      if (!items.length){
        eventsEl.innerHTML = `<div class="empty">ä»Šå¾Œã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      allEvents = [];
      eventsByDate.clear();

      items.forEach((e)=>{
        const startIso = e.start?.dateTime || (e.start?.date ? e.start.date + 'T00:00:00' : null);
        const endIso   = e.end?.dateTime   || (e.end?.date   ? e.end.date   + 'T23:59:59' : null);
        if (!startIso) return;

        const { fields, body } = parseFields(e.description || '');
        const venue  = e.location || fields.venue || '';
        const price  = fields.price || '';
        const ticket = fields.ticket || '';
        const site   = fields.url || '';
        const note   = fields.note || '';
        const flyer  = fields.flyer || '';
        const mapUrl = buildMapUrl(fields, venue);

        const ymd = toYMD(startIso);
        const bodyHtml = body ? body.replace(/\n/g,'<br>') : '';

        const obj = {
          raw:e,
          ymd,
          startIso,
          endIso,
          summary:e.summary || '',
          venue,
          price,
          ticket,
          site,
          note,
          flyer,
          mapUrl,
          bodyHtml,
        };

        allEvents.push(obj);

        if (!eventsByDate.has(ymd)) eventsByDate.set(ymd,[]);
        eventsByDate.get(ymd).push(obj);
      });

      // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
      allEvents.sort((a,b)=> new Date(a.startIso) - new Date(b.startIso));
      eventsByDate.forEach(list => list.sort((a,b)=> new Date(a.startIso) - new Date(b.startIso)));

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠï¼šä¸€ç•ªè¿‘ã„ã‚¤ãƒ™ãƒ³ãƒˆã®æ—¥
      const now = new Date();
      const upcoming = allEvents.find(ev => new Date(ev.startIso) >= now) || allEvents[0];
      selectedDate = upcoming.ymd;
      currentMonth = new Date(upcoming.startIso);

      renderCalendar();
      renderEvents();
    }

    document.getElementById('cal-prev').addEventListener('click',()=>{
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1);
      renderCalendar();
    });
    document.getElementById('cal-next').addEventListener('click',()=>{
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1);
      renderCalendar();
    });

    loadEvents();
  </script>
</body>
</html>
