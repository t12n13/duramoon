<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | Dura Moon</title>
  <link rel="stylesheet" href="assets/common.css">
  <link rel="icon" type="image/png" href="/duramoon/favicon.png" />

  <style>
    /* --- ãƒ©ã‚¤ãƒ–æ„Ÿã®ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .section-title { display:flex; align-items:center; gap:10px; margin: 12px 0 18px; }
    .section-title .icon { font-size:22px; }
    .events { display: grid; grid-template-columns: 1fr; gap: 14px; }

    .event-card {
      position: relative;
      border-radius: 16px;
      padding: 18px 16px 14px;
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.1);
      overflow: hidden;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .event-card::before {
      content:"";
      position:absolute; inset:-1px;
      border-radius:18px;
      padding:1px;
      background: linear-gradient(135deg, rgba(255,61,138,.8), rgba(115,135,255,.85) 40%, rgba(40,190,255,.9));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      opacity:.45;
      pointer-events:none;
    }
    .event-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
    }

    .event-title {
      font-weight:700;
      font-size:1.15rem;
      margin:0 0 4px;
    }
    .event-meta {
      color:#b8c0cc;
      font-size:.95rem;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .pill {
      background: rgba(255,255,255,.09);
      border:1px solid rgba(255,255,255,.08);
      padding:6px 10px;
      border-radius:100px;
    }
    .dot {
      width:6px;
      height:6px;
      border-radius:50%;
      background:rgba(255,255,255,.35);
      display:inline-block;
    }

    .btns {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:14px;
    }
    .btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      color:#f5f7ff;
      font-weight:700;
      background: rgba(28,30,40,.7);
      text-decoration:none;
      transition: filter .15s ease, transform .15s ease;
    }
    .btn.ticket { background: linear-gradient(135deg, #ff4da6, #7b5cff); }
    .btn.site   { background: linear-gradient(135deg, #23c6ff, #358bff); }
    .btn:hover  { filter: brightness(1.08); transform: translateY(-1px); }

    .empty {
      color:#dbe2f3;
      opacity:.85;
      padding:18px 16px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.15);
      background: rgba(255,255,255,.04);
      margin-top:12px;
    }

    /* --- å¼·èª¿è¡¨ç¤ºï¼ˆä¼šå ´ãƒ»å‡ºæ¼”æ™‚é–“ãƒ»ç‰¹å…¸ä¼šãƒ»å‹•å“¡ç‰¹å…¸ï¼‰ --- */
    .event-meta-detail {
      display:flex;
      flex-direction:column;  /* ç¸¦ä¸¦ã³ */
      gap:4px;
      margin-top:8px;
    }
    .pill-strong {
      background: rgba(255,255,255,0.18) !important;
      border: 1px solid rgba(255,255,255,0.25) !important;
      color: #ffffff;
      font-weight: 700;
      font-size: 1.05rem;
      display: inline-block;
    }

    /* --- ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆimg:ã€œ ã§æŒ‡å®šã•ã‚ŒãŸç”»åƒï¼‰ --- */
    .event-images {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-start;
    }
    .event-images img {
      width: 280px;          /* PCã§ã€Œã„ã„æ„Ÿã˜ã€ã®å¤§ãã• */
      max-width: 100%;       /* ã‚¹ãƒãƒ›ã§ã¯æ¨ªå¹…ã«ãƒ•ã‚£ãƒƒãƒˆ */
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      object-fit: cover;
      cursor: pointer;
      transition: transform .15s ease, opacity .15s ease;
    }
    .event-images img:hover {
      transform: scale(1.03);
      opacity: .9;
    }

    /* ===== ã‚¹ãƒãƒ›å¯¾å¿œå¼·åŒ– ===== */
    @media (max-width: 768px) {
      .wrap {
        padding: 12px;
      }

      .event-card {
        padding: 14px 12px;
        border-radius: 12px;
      }

      .event-title {
        font-size: 1.05rem;
        line-height: 1.3;
      }

      .event-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        font-size: 0.9rem;
      }

      .pill {
        display: inline-block;
        margin: 2px 0;
      }

      .btns {
        flex-direction: column;
        gap: 8px;
      }

      .btn {
        width: 100%;
        text-align: center;
        font-size: 0.9rem;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="section-title"><span class="icon">ğŸ“…</span> ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
      <p>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰äºˆå®šã‚’å–å¾—ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å´ã‚’æ›´æ–°ã™ã‚‹ã¨è‡ªå‹•ã§åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
      <nav><a class="btn" href="./">SNSã¾ã¨ã‚</a></nav>
    </header>

    <section id="list">
      <div id="events" class="events"></div>
    </section>
  </div>

  <script src="assets/config.js"></script>
  <script>
    // ==== æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ====
    const fmtJP = iso => new Intl.DateTimeFormat('ja-JP', {
      year:'numeric', month:'long', day:'numeric',
      weekday:'short', hour:'2-digit', minute:'2-digit', hour12:false
    }).format(new Date(iso));

    const fmtHM = iso => new Intl.DateTimeFormat('ja-JP', {
      hour:'2-digit', minute:'2-digit', hour12:false
    }).format(new Date(iso));

    const daysLeft = iso => {
      const now = new Date(), t = new Date(iso);
      const ms = t.setHours(0,0,0,0) - now.setHours(0,0,0,0);
      return Math.floor(ms / (1000*60*60*24));
    };

    // ==== descriptionã‚’è§£æï¼ˆticket / url / price / venue / live / photo / bonus / imgï¼‰====
    function parseFields(desc = '') {
      const fields = {};

      // æ­£è¦åŒ–ï¼šæ”¹è¡Œ / å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ / <br> ã‚’çµ±ä¸€
      const norm = String(desc)
        .replace(/\r\n/g, '\n')
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/\u00A0/g, ' ')
        .replace(/\u3000/g, ' ');    // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ â†’ åŠè§’

      const lines = norm.split('\n');

      // æ—¥æœ¬èªã‚­ãƒ¼ã‚‚è¨±å®¹
      const KEYMAP = {
        'ticket': 'ticket', 'ãƒã‚±ãƒƒãƒˆ': 'ticket',
        'url': 'url', 'link': 'url', 'ãƒªãƒ³ã‚¯': 'url',
        'price': 'price', 'æ–™é‡‘': 'price', 'é‡‘é¡': 'price',
        'venue': 'venue', 'ä¼šå ´': 'venue', 'å ´æ‰€': 'venue',
        'live': 'live', 'å‡ºæ¼”æ™‚é–“': 'live',
        'photo': 'photo', 'ç‰¹å…¸ä¼š': 'photo',
        'bonus': 'bonus', 'å‹•å“¡ç‰¹å…¸': 'bonus',
        'img': 'img'
      };

      for (let raw of lines) {
        if (!raw) continue;
        const line = raw.trim();

        // å…ˆé ­ã«çµµæ–‡å­—ã‚„è¨˜å·ãŒæ¥ã¦ã‚‚ç„¡è¦–ã—ã¦ãƒãƒƒãƒï¼ˆä¾‹: "ğŸ« ticket: ..."ï¼‰
        const m = line.match(/^[^\wã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥]*(ticket|ãƒã‚±ãƒƒãƒˆ|url|link|ãƒªãƒ³ã‚¯|price|æ–™é‡‘|é‡‘é¡|venue|ä¼šå ´|å ´æ‰€|live|å‡ºæ¼”æ™‚é–“|photo|ç‰¹å…¸ä¼š|bonus|å‹•å“¡ç‰¹å…¸|img)\s*[:ï¼š]\s*(.+)$/i);
        if (!m) continue;

        const keyRaw = m[1].toLowerCase();
        const key = KEYMAP[keyRaw] || keyRaw;

        // å€¤ã®æœ«å°¾ã®è£…é£¾ãƒ»ä½™è¨ˆãªç©ºç™½ã‚’é™¤å»
        let val = m[2]
          .replace(/\s+$/g, '')
          .replace(/<[^>]*>$/g, '')
          .trim();

        // img: ã¯è¤‡æ•°è¡Œå¯¾å¿œ
        if (key === 'img') {
          if (!fields.img) fields.img = [];
          if (val) fields.img.push(val);
          continue;
        }

        // URLè¡Œã¯æœ€åˆã®URLã ã‘å–ã‚‹ï¼ˆå¾Œã‚ã«æ–‡å­—ãŒç¶šã„ã¦ã‚‚å®‰å…¨ï¼‰
        if (key === 'ticket' || key === 'url') {
          const urlMatch = val.match(/https?:\/\/[^\sã€€"'<>]+/i);
          if (urlMatch) {
            val = urlMatch[0];
          } else {
            val = '';
          }
        }

        if (val) fields[key] = val;
      }

      return fields;
    }

    function googleEventUrl(e) {
      return e.htmlLink || `https://calendar.google.com/calendar/u/0/r/eventedit?text=${encodeURIComponent(e.summary||'')}`;
    }

    async function loadEvents() {
      const el = document.getElementById('events');
      el.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';

      const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CONFIG.CAL_ID)}/events`);
      url.searchParams.set('key', CONFIG.API_KEY);
      url.searchParams.set('singleEvents', 'true');
      url.searchParams.set('orderBy', 'startTime');

      // ä»Šæ—¥ã®0:00ä»¥é™
      const timeMin = new Date();
      timeMin.setHours(0,0,0,0);
      url.searchParams.set('timeMin', timeMin.toISOString());

      url.searchParams.set('maxResults', '50');

      const res = await fetch(url);
      if (!res.ok) {
        el.innerHTML = `<div class="empty">èª­ã¿è¾¼ã¿å¤±æ•—ã€‚APIã‚­ãƒ¼è¨­å®šã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å…¬é–‹è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
        return;
      }

      const data = await res.json();
      const items = (data.items || []).filter(e => e.status !== 'cancelled');
      if (!items.length) {
        el.innerHTML = `<div class="empty">ä»Šå¾Œã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      el.innerHTML = '';

      for (const e of items) {
        const start = e.start?.dateTime || (e.start?.date ? e.start.date + 'T00:00:00' : null);
        const end   = e.end?.dateTime   || (e.end?.date   ? e.end.date   + 'T23:59:59' : null);
        if (!start) continue;

        const fields = parseFields(e.description || '');
        const venue  = fields.venue || '';
        const price  = fields.price || '';
        const ticket = fields.ticket || '';
        const site   = fields.url   || '';
        const live   = fields.live  || '';
        const photo  = fields.photo || '';
        const bonus  = fields.bonus || '';
        const images = fields.img   || [];

        const d = daysLeft(start);
        const countdown = d >= 0 ? `<span class="pill">â³ ã‚ã¨${d}æ—¥</span>` : '';

        const card = document.createElement('article');
        card.className = 'event-card';
        card.innerHTML = `
          <h3 class="event-title">${e.summary || '(ç„¡é¡Œ)'}</h3>

          <!-- ä¸Šæ®µï¼šé€šå¸¸ãƒ¡ã‚¿æƒ…å ±ï¼ˆæ—¥ä»˜ãƒ»æ™‚é–“ãƒ»æ–™é‡‘ãªã©ï¼‰ -->
          <div class="event-meta">
            <span class="pill">ğŸ“… ${fmtJP(start)}</span>
            <span class="pill">ğŸ•’ ${fmtHM(start)}ã€œ${end ? fmtHM(end) : ''}</span>
            ${price ? `<span class="pill">ğŸ’´ ${price}</span>` : ''}
            ${countdown}
          </div>

          <!-- ä¸‹æ®µï¼šä¼šå ´ãƒ»å‡ºæ¼”æ™‚é–“ãƒ»ç‰¹å…¸ä¼šãƒ»å‹•å“¡ç‰¹å…¸ï¼ˆç¸¦ä¸¦ã³ï¼‹å¼·èª¿ï¼‰ -->
          <div class="event-meta event-meta-detail">
            ${venue ? `<span class="pill pill-strong">ğŸ“ ä¼šå ´ï¼š${venue}</span>` : ''}
            ${live  ? `<span class="pill pill-strong">ğŸ¤ å‡ºæ¼”æ™‚é–“ï¼š${live}</span>` : ''}
            ${photo ? `<span class="pill pill-strong">ğŸ“· ç‰¹å…¸ä¼šï¼š${photo}</span>` : ''}
            ${bonus ? `<span class="pill pill-strong">ğŸ å‹•å“¡ç‰¹å…¸ï¼š${bonus}</span>` : ''}
          </div>

          <!-- ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ -->
          ${
            images.length
              ? `<div class="event-images">
                  ${images.map(src =>
                    `<img src="${src}" alt="" onclick="window.open('${src}', '_blank')">`
                  ).join('')}
                 </div>`
              : ''
          }

          <div class="btns">
            ${ticket ? `<a class="btn ticket" href="${ticket}" target="_blank" rel="noopener">ğŸ« ãƒã‚±ãƒƒãƒˆ</a>` : ''}
            ${site   ? `<a class="btn site"   href="${site}"   target="_blank" rel="noopener">ğŸ”— Xã§è©³ç´°ã‚’ç¢ºèªã™ã‚‹</a>` : ''}
            <a class="btn" href="${googleEventUrl(e)}" target="_blank" rel="noopener">ğŸ“† Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§é–‹ã</a>
          </div>
        `;
        el.appendChild(card);
      }
    }

    window.addEventListener('DOMContentLoaded', loadEvents);
  </script>
</body>
</html>
