<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | Dura Moon</title>
  <link rel="stylesheet" href="assets/common.css">
  <link rel="icon" type="image/png" href="/duramoon/favicon.png" />

  <style>
    /* --- ãƒ©ã‚¤ãƒ–æ„Ÿã®ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .section-title { display:flex; align-items:center; gap:10px; margin: 12px 0 18px; }
    .section-title .icon { font-size:22px; }
    .events { display: grid; grid-template-columns: 1fr; gap: 14px; }

    .event-card {
      position: relative;
      border-radius: 16px;
      padding: 18px 16px 14px;
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.1);
      overflow: hidden;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .event-card::before {
      content:"";
      position:absolute; inset:-1px;
      border-radius:18px;
      padding:1px;
      background: linear-gradient(135deg, rgba(255,61,138,.8), rgba(115,135,255,.85) 40%, rgba(40,190,255,.9));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      opacity:.45;
      pointer-events:none;
    }
    .event-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
    }

    .event-title { font-weight:700; font-size:1.15rem; margin:0 0 4px; }
    .event-meta { color:#b8c0cc; font-size:.95rem; display:flex; flex-wrap:wrap; gap:8px; }
    .pill { background: rgba(255,255,255,.09); border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:100px; }
    .dot { width:6px; height:6px; border-radius:50%; background:rgba(255,255,255,.35); display:inline-block; }
    .btns { display:flex; flex-wrap:wrap; gap:10px; margin-top:14px; }
    .btn {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      color:#f5f7ff; font-weight:700;
      background: rgba(28,30,40,.7); text-decoration:none;
    }
    .btn.ticket { background: linear-gradient(135deg, #ff4da6, #7b5cff); }
    .btn.site   { background: linear-gradient(135deg, #23c6ff, #358bff); }
    .btn:hover { filter: brightness(1.08); transform: translateY(-1px); }

    /* --- å¼·èª¿è¡¨ç¤ºï¼ˆä¼šå ´ï¼å‡ºæ¼”æ™‚é–“ï¼ç‰¹å…¸ä¼šï¼å‹•å“¡ç‰¹å…¸ï¼‰ --- */
    .pill-strong {
      background: rgba(255,255,255,0.18) !important;
      border: 1px solid rgba(255,255,255,0.25) !important;
      color: #ffffff;
      font-weight: 700;
      font-size: 1.05rem;
    }
    .event-meta-detail {
      flex-direction: column;
      align-items: flex-start;
      margin-top: 10px;
      gap: 6px;
    }

    /* ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .event-images {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .event-images img {
      display:block;
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    /* ===== ã‚¹ãƒãƒ›å¯¾å¿œå¼·åŒ– ===== */
    @media (max-width: 768px) {
      .wrap {
        padding: 12px;
      }
      .event-card {
        padding: 14px 12px;
        border-radius: 12px;
      }
      .event-title {
        font-size: 1.05rem;
        line-height: 1.3;
      }
      .event-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        font-size: 0.9rem;
      }
      .pill {
        display: inline-block;
        margin: 2px 0;
      }
      .btns {
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        width: 100%;
        text-align: center;
        font-size: 0.9rem;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="section-title"><span class="icon">ğŸ“…</span> ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
      <p>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰äºˆå®šã‚’å–å¾—ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å´ã‚’æ›´æ–°ã™ã‚‹ã¨è‡ªå‹•ã§åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
      <nav><a class="btn" href="./">SNSã¾ã¨ã‚</a></nav>
    </header>

    <section id="list">
      <div id="events" class="events"></div>
    </section>
  </div>

  <script src="assets/config.js"></script>
  <script>
    // ==== æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ====
    const fmtJP = iso => new Intl.DateTimeFormat('ja-JP', {
      year:'numeric', month:'long', day:'numeric',
      weekday:'short', hour:'2-digit', minute:'2-digit', hour12:false
    }).format(new Date(iso));

    const fmtHM = iso => new Intl.DateTimeFormat('ja-JP', {
      hour:'2-digit', minute:'2-digit', hour12:false
    }).format(new Date(iso));

    const daysLeft = iso => {
      const now = new Date(), t = new Date(iso);
      const ms = t.setHours(0,0,0,0) - now.setHours(0,0,0,0);
      return Math.floor(ms / (1000*60*60*24));
    };

    // ==== description ã‚’è§£æ ====
    function parseFields(desc = '') {
      const fields = {};

      const norm = String(desc)
        .replace(/\r\n/g, '\n')
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/\u00A0/g, ' ')
        .replace(/\u3000/g, ' ');

      const lines = norm.split('\n');

      const KEYMAP = {
        'ticket': 'ticket', 'ãƒã‚±ãƒƒãƒˆ': 'ticket',
        'url': 'url', 'link': 'url', 'ãƒªãƒ³ã‚¯': 'url',
        'price': 'price', 'æ–™é‡‘': 'price', 'é‡‘é¡': 'price',
        'venue': 'venue', 'ä¼šå ´': 'venue', 'å ´æ‰€': 'venue',
        'live': 'live', 'å‡ºæ¼”æ™‚é–“': 'live',
        'photo': 'photo', 'ç‰¹å…¸ä¼š': 'photo',
        'bonus': 'bonus', 'å‹•å“¡ç‰¹å…¸': 'bonus',
        'img': 'img', 'ç”»åƒ': 'img'
      };

      for (let raw of lines) {
        if (!raw) continue;
        const line = raw.trim();

        const m = line.match(
          /^[^\wã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥]*(ticket|ãƒã‚±ãƒƒãƒˆ|url|link|ãƒªãƒ³ã‚¯|price|æ–™é‡‘|é‡‘é¡|venue|ä¼šå ´|å ´æ‰€|live|å‡ºæ¼”æ™‚é–“|photo|ç‰¹å…¸ä¼š|bonus|å‹•å“¡ç‰¹å…¸|img|ç”»åƒ)\s*[:ï¼š]\s*(.+)$/i
        );
        if (!m) continue;

        const keyRaw = m[1].toLowerCase();
        const key = KEYMAP[keyRaw] || keyRaw;

        let val = m[2]
          .replace(/\s+$/g, '')
          .replace(/<[^>]*>$/g, '')
          .trim();

        // ç”»åƒã¯é…åˆ—ã§
        if (key === 'img') {
          if (!fields.img) fields.img = [];
          const urlMatch = val.match(/https?:\/\/[^\sã€€"'<>]+/i);
          if (urlMatch) fields.img.push(urlMatch[0]);
          continue;
        }

        // ticket / url ã¯ URL éƒ¨ã ã‘
        if (key === 'ticket' || key === 'url') {
          const urlMatch = val.match(/https?:\/\/[^\sã€€"'<>]+/i);
          if (urlMatch) val = urlMatch[0];
        }

        if (val) fields[key] = val;
      }

      return fields;
    }

    function googleEventUrl(e) {
      return e.htmlLink || `https://calendar.google.com/calendar/u/0/r/eventedit?text=${encodeURIComponent(e.summary||'')}`;
    }

    async function loadEvents() {
      const el = document.getElementById('events');
      el.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';

      const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CONFIG.CAL_ID)}/events`);
      url.searchParams.set('key', CONFIG.API_KEY);
      url.searchParams.set('singleEvents', 'true');
      url.searchParams.set('orderBy', 'startTime');
      url.searchParams.set('timeMin', new Date().toISOString());
      url.searchParams.set('maxResults', '50');

      const res = await fetch(url);
      if (!res.ok) {
        el.innerHTML = `<div class="empty">èª­ã¿è¾¼ã¿å¤±æ•—ã€‚APIã‚­ãƒ¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
        return;
      }

      const data = await res.json();
      const items = (data.items || []).filter(e => e.status !== 'cancelled');
      if (!items.length) {
        el.innerHTML = `<div class="empty">ä»Šå¾Œã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      el.innerHTML = '';
      for (const e of items) {
        const start = e.start?.dateTime || (e.start?.date ? e.start.date + 'T00:00:00' : null);
        const end   = e.end?.dateTime   || (e.end?.date   ? e.end.date   + 'T23:59:59' : null);
        if (!start) continue;

        const fields = parseFields(e.description || '');
        const venue  = fields.venue || e.location || '';
        const price  = fields.price || '';
        const ticket = fields.ticket || '';
        const site   = fields.url || '';
        const live   = fields.live || '';
        const photo  = fields.photo || '';
        const bonus  = fields.bonus || '';
        const images = fields.img || [];

        const d = daysLeft(start);
        const countdownText = d >= 0 ? `ã‚ã¨${d}æ—¥` : '';

        const card = document.createElement('article');
        card.className = 'event-card';

        // ã‚¿ã‚¤ãƒˆãƒ«
        const titleEl = document.createElement('h3');
        titleEl.className = 'event-title';
        titleEl.textContent = e.summary || '(ç„¡é¡Œ)';
        card.appendChild(titleEl);

        // ä¸Šæ®µãƒ¡ã‚¿
        const metaTop = document.createElement('div');
        metaTop.className = 'event-meta';

        const datePill = document.createElement('span');
        datePill.className = 'pill';
        datePill.textContent = `ğŸ“… ${fmtJP(start)}`;
        metaTop.appendChild(datePill);

        if (end) {
          const timePill = document.createElement('span');
          timePill.className = 'pill';
          timePill.textContent = `ğŸ•’ ${fmtHM(start)}ã€œ${fmtHM(end)}`;
          metaTop.appendChild(timePill);
        }

        if (price) {
          const pricePill = document.createElement('span');
          pricePill.className = 'pill';
          pricePill.textContent = `ğŸ’´ ${price}`;
          metaTop.appendChild(pricePill);
        }

        if (countdownText) {
          const cdPill = document.createElement('span');
          cdPill.className = 'pill';
          cdPill.textContent = `â³ ${countdownText}`;
          metaTop.appendChild(cdPill);
        }

        card.appendChild(metaTop);

        // ä¸‹æ®µãƒ¡ã‚¿ï¼ˆä¼šå ´ï¼liveï¼photoï¼bonusï¼‰
        const metaDetail = document.createElement('div');
        metaDetail.className = 'event-meta event-meta-detail';

        if (venue) {
          const v = document.createElement('span');
          v.className = 'pill pill-strong';
          v.textContent = `ğŸ“ ä¼šå ´ï¼š${venue}`;
          metaDetail.appendChild(v);
        }
        if (live) {
          const v = document.createElement('span');
          v.className = 'pill pill-strong';
          v.textContent = `ğŸ¤ å‡ºæ¼”æ™‚é–“ï¼š${live}`;
          metaDetail.appendChild(v);
        }
        if (photo) {
          const v = document.createElement('span');
          v.className = 'pill pill-strong';
          v.textContent = `ğŸ“· ç‰¹å…¸ä¼šï¼š${photo}`;
          metaDetail.appendChild(v);
        }
        if (bonus) {
          const v = document.createElement('span');
          v.className = 'pill pill-strong';
          v.textContent = `ğŸ å‹•å“¡ç‰¹å…¸ï¼š${bonus}`;
          metaDetail.appendChild(v);
        }

        card.appendChild(metaDetail);

        // ç”»åƒã‚¨ãƒªã‚¢
        if (images.length) {
          const imgWrap = document.createElement('div');
          imgWrap.className = 'event-images';
          images.forEach(src => {
            const a = document.createElement('a');
            a.href = src;
            a.target = '_blank';
            a.rel = 'noopener';

            const img = document.createElement('img');
            img.src = src;
            img.alt = '';

            a.appendChild(img);
            imgWrap.appendChild(a);
          });
          card.appendChild(imgWrap);
        }

        // ãƒœã‚¿ãƒ³
        const btns = document.createElement('div');
        btns.className = 'btns';

        if (ticket) {
          const bt = document.createElement('a');
          bt.className = 'btn ticket';
          bt.href = ticket;
          bt.target = '_blank';
          bt.rel = 'noopener';
          bt.textContent = 'ğŸ« ãƒã‚±ãƒƒãƒˆ';
          btns.appendChild(bt);
        }

        if (site) {
          const bs = document.createElement('a');
          bs.className = 'btn site';
          bs.href = site;
          bs.target = '_blank';
          bs.rel = 'noopener';
          bs.textContent = 'ğŸ”— Xã§è©³ç´°ã‚’ç¢ºèªã™ã‚‹';
          btns.appendChild(bs);
        }

        const bg = document.createElement('a');
        bg.className = 'btn';
        bg.href = googleEventUrl(e);
        bg.target = '_blank';
        bg.rel = 'noopener';
        bg.textContent = 'ğŸ“† Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§é–‹ã';
        btns.appendChild(bg);

        card.appendChild(btns);

        el.appendChild(card);
      }
    }

    loadEvents();
  </script>
</body>
</html>
